{% extends "main/static/base.html" %}
{% load static %}
{% block content %}
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>   
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Форма для включения/выключения уведомлений в Telegram -->
<div class="container my-4">
    <div class="card">
        <div class="card-header cardToggle">
            <h3>Настройки оповещений в Telegram</h3>
            <span class="float-right">Развернуть &#9660;</span> 
        </div>
        <div class="card-body"  style="display: none;">
            <form id="telegramNotificationForm" method="post" action="{% url 'users:toggle_telegram_notifications' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="telegram_chat_id">Chat ID или username:</label>
                    <input type="text" class="form-control" name="telegram_chat_id" id="telegram_chat_id" placeholder="Введите ваш Chat ID" title="Уникальный идентификатор чата, который вы получите после первого сообщения боту" value="{{ request.user.userprofile.telegram_chat_id }}">
                    <small class="form-text text-muted"><a href="https://t.me/username_to_id_bot" target="_blank">Получить ID можно тут</a></small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="telegram_notifications" id="telegram_notifications" {% if request.user.userprofile.telegram_notifications %}checked{% endif %}>
                    <label class="form-check-label" for="telegram_notifications">Получать уведомления в Telegram</label>
                    <small class="form-text text-muted"><a href="https://t.me/SpamSticker11111_bot" target="_blank">В первый раз нужно запустить Бота</a></small>
                </div>
                <input type="submit" class="btn btn-primary mt-3" value="Сохранить">
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header cardToggle">
            <h3>Управление отслеживаемыми словами</h3>
            <span class="float-right">Скрыть &#9650;</span> 

        </div>
        <div class="card-body" style="display: ;">
            <form id="addWordForm" method="post" class="mb-3">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-success">Добавить слово</button>
            </form>

            <ul id="wordList" class="list-group">
                {% for item in words_with_counts %}
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ item.word.id }}">
                    {{ item.word.keyword }}
                    <span class="badge badge-primary badge-pill">{{ item.count }}</span>
                    <button class="btn btn-danger btn-sm deleteWord">Удалить</button>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var csrftoken = $("[name=csrfmiddlewaretoken]").val();
    $("#addWordForm").submit(function(e) {
        e.preventDefault();
        $.post("{% url 'users:add_word_api' %}", $(this).serialize()).done(function(data) {
            if (data.status == 'success') {
                $("#wordList").append('<li class="list-group-item d-flex justify-content-between align-items-center" data-id="' 
                + data.word_id + '">' + data.word_text + 
                '<span class="badge badge-primary badge-pill">'+ data.count + '</span>' +
                ' <button class="btn btn-danger btn-sm deleteWord">Удалить</button></li>');
            } else {
                alert(data.errors.keyword);
            }
        });
    });

    $("#wordList").on("click", ".deleteWord", function() {
        var li = $(this).closest('li');
        var wordId = li.attr('data-id');
        $.ajax({
            url: "{% url 'users:delete_word_api' '0' %}".replace('0', wordId),
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(data) {
                if (data.status == 'success') {
                    li.remove();
                } else {
                    alert(data.message);
                }
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.cardToggle').on('click', function() {
            const cardBody = $(this).next('.card-body');
            cardBody.slideToggle('slow');
    

        });
    });
</script>

{% endblock %}
